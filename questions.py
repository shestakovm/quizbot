from datetime import datetime, timedelta
import pytz

moscow_tz = pytz.timezone('Europe/Moscow')


def get_initial_questions():
    """Базовая структура вопросов без времени"""
    return {
        1: {
            'text': '''Загадка #1\n
            Выберите что из этого было создано в древнем Китае и используется по сей день?\n Варианты ответа: 1. Велосипед, 2. Чвй, 3. Ручка, 4. Зеркало, 5. Лук и стрелы, 6. Спички''',
            'options': [
                'Велосипед',
                'Чай',
                'Ручка',
                'Зеркало',
                'Лук и стрелы',
                'Спички'
            ],
            'correct_answer': 'чай',
            'question_image': 'question1.jpg',
            'image_correct': 'question1_fragment.png',
            'wrong_answer_text': 'Ой-ой-ой! Это не то, что мы загадали. Но не переживайте, вы еще можете победить.',
            'correct_answer_text': 'Поздравляем, вы правильно ответили на вопрос, держите фрагмент финальной загадки'
        },
        2: {
            'text': '''Загадка #2\n
            В далеком прошлом, в веках минувших, 
            Секреты мои в тени скрыты, 
            Кто я, скажи, если в III веке, 
            Мудрец меня описал, не в шутке. 
            Ложка моя, из магнита сделана, 
            С узкой ручкой, форма — как шар, 
            С помощью меня, дороги открыты, 
            Что за изобретение, скажи, не зная преград?.''',
            'correct_answer': 'компас',
            'hint': 'В конструкции использовался магнитный минерал, который позволяет ему указывать на сторону света',
            'hint_delay': 120,  # 2 минуты в секундах
            'image_correct': 'question2_fragment.png',
            'wrong_answer_text': 'Ой-ой-ой! Это не то, что мы загадали. Но не переживайте, вы еще можете победить.',
            'correct_answer_text': 'Поздравляем, вы правильно ответили на вопрос, держите фрагмент финальной загадки'
        },
        3: {
            'text': '''Загадка #3\n
            Китай — страна с одной из самых высоких степеней индустриализации и урбанизации в мире регулярно сталкивается с серьезными экологическими вызовами. Однако, в последние годы, благодаря государственной поддержке и частным инвестициям, Китай становится лидером в области экологических технологий. Взгляните на картинки и напишите название провинции, в которой в 2018 году был реализован революционный проект, который тут зашифрован.''',
            'correct_answer': 'сычуань',
            'question_image': 'question3.jpg',
            'image_correct': 'question3_fragment.png',
            'wrong_answer_text': 'Ой-ой-ой! Это не то, что мы загадали. Но не переживайте, вы еще можете победить.',
            'correct_answer_text': 'Поздравляем, вы правильно ответили на вопрос, держите фрагмент финальной загадки'
        },
        4: {
            'text': '''Загадка #4\n
        Вы удивитесь, но в Китае очень любят русские песни. Напишите название песни, которая звучит.''',
            'correct_answer': 'группа крови',
            'image_correct': 'question4_fragment.png',
            'video_path': 'videoquestion.mp4',
            'wrong_answer_text': 'Ой-ой-ой! Это не то, что мы загадали. Но не переживайте, вы еще можете победить.',
            'correct_answer_text': 'Поздравляем, вы правильно ответили на вопрос, держите фрагмент финальной загадки'
        },
        5: {
            'text': '''Загадка #5\n
            Одной из 30 вакансий, на которые откликнулся ЭТОТ ЧЕЛОВЕК после окончания колледжа, была позиция сотрудника ресторанов общественного питания KFC.
    Из 24 кандидатов KFC утвердила 23, и ОН был единственным претендентом, не получившим работу.

    Так же ОН утверждает, что мало что смыслит в информационных технологиях, хотя ОН владеет одной из самых успешных технологических компаний в мире.
    «Я совсем не разбираюсь в информационных технологиях. Единственное, что я могу, — использовать компьютер, чтобы загружать страницы в интернете, а также отправлять и получать электронные сообщения».

    О ком идет речь?''',
            'correct_answer': 'джек ма',
            'image_correct': 'question5_fragment.png',
            'wrong_answer_text': 'Ой-ой-ой! Это не то, что мы загадали. Но не переживайте, вы еще можете победить.',
            'correct_answer_text': 'Поздравляем, вы правильно ответили на вопрос, держите фрагмент финальной загадки'
        },
        6: {
            'text': '''Настало время собрать все фрагменты и написать что же за товар мы загадали?
Пишите свою версию, но хорошенько подумайте, у вас только одна попытка! Итоги подведем 12 февраля.''',
            'question_image': 'question6.png',
            'collect_answers': True
        }
    }


def get_initial_info_posts():
    """Базовая структура информационных постов без времени"""
    return {
        1: {
            'text': '''Китайский Новый год!
В некоторых регионах Китая существует традиция "первого визита". В первый день Нового года люди стараются не посещать своих друзей и соседей, чтобы не принести им неудачу. Вместо этого они ждут, пока кто-то не посетит их первым.
''',
            'image_path': 'infopost1.jpg',
        },
        2: {
            'text': '''Правда или миф?\n Как вы думаете что из этого правда, а что миф? Баллы не дадим, но кругозор расширим.
        - У китайцев есть традиция есть пельмени на Новый год для привлечения удачи.
        - Все китайцы отмечают Новый год в один и тот же день, независимо от региона.
        - Великая китайская стена видна с Луны невооруженным глазом.
        - В Китае полагается, что густые бороды приносят удачу.
        - В Китае принято дарить часы на день рождения.
        - Существует традиция выбрасывать ненужные вещи в Новый год, чтобы освободить место для нового счастья.
        - В Китае люди употребляют чай на завтрак, обед и ужин.
        - Китайцы используют фейерверки исключительно для празднования китайского Нового года.
        - В Китае "число 8" считается неудачным.
        - Лунный календарь используется в Китае для определения всех важных праздников и мероприятий.''',
        },
        3: {
            'text': ''' 
            Сегодня мы предлагаем вам потренировать свою внимательность вместе со всем известной героиней китайской поэмы Khua Mulan (кит. 花木兰), которая пошла на войну вместо своего престарелого отца, несмотря на то, что в армию принимали только мужчин.

        Поэма «Песня о Мулан» была написана в VI веке, но, к сожалению, первоначальная версия не сохранилась. Позднейшая версия, собранная в XII веке Го Маоцзяном, стала основой для многих интерпретаций. Интересно, имела ли Mulan реальный прототип — это остается загадкой.

        Что нужно сделать?
        Найдите 11 отличий в кадре всемирно известного мультфильма о храброй Мулан!''',
            'image_path': 'infopost3.png'
        }
    }


def initialize_times(start_delay_minutes=1):
    """Инициализация времен для вопросов и инфо-постов"""
    now = datetime.now(moscow_tz)

    questions = get_initial_questions()
    info_posts = get_initial_info_posts()

    # Устанавливаем времена для вопросов
    for q_id in questions:
        questions[q_id]['start_time'] = now + timedelta(minutes=start_delay_minutes + (q_id - 1) * 5)
        questions[q_id]['end_time'] = questions[q_id]['start_time'] + timedelta(minutes=4)
        questions[q_id]['notified'] = False  # Флаг для отслеживания отправки

    # Устанавливаем времена для инфо-постов
    post_times = {1: 3, 2: 13, 3: 23}  # минуты для каждого поста
    for post_id in info_posts:
        info_posts[post_id]['publish_time'] = now + timedelta(minutes=post_times[post_id])
        info_posts[post_id]['notified'] = False  # Флаг для отслеживания отправки

    return questions, info_posts


# Инициализируем глобальные переменные
QUESTIONS, INFO_POSTS = initialize_times()


def reset_times(start_delay_minutes=1):
    """Функция для сброса времен (используется при перезапуске)"""
    global QUESTIONS, INFO_POSTS
    QUESTIONS, INFO_POSTS = initialize_times(start_delay_minutes)