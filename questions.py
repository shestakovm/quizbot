from datetime import datetime
import pytz

moscow_tz = pytz.timezone('Europe/Moscow')


def get_initial_questions():
    """Базовая структура вопросов без времени"""
    return {
        1: {
            'text': '''Загадка #1\nОтветы принимаются до 30.01 08:00\n
            Выберите что из этого было создано в древнем Китае и используется по сей день?\nВарианты ответа: 1. Велосипед, 2. Чай, 3. Ручка, 4. Зеркало, 5. Лук и стрелы, 6. Спички\nОтвет написать словом, например: Матрёшка.''',
            'options': [
                'Велосипед',
                'Чай',
                'Ручка',
                'Зеркало',
                'Лук и стрелы',
                'Спички'
            ],
            'correct_answer': 'чай',
            'question_image': 'question1.jpg',
            'image_correct': 'question1_fragment.png',
            'wrong_answer_text': 'Ой-ой-ой! Это не то, что мы загадали. Но не переживайте, вы еще можете победить.',
            'correct_answer_text': 'Поздравляем, вы правильно ответили на вопрос, держите фрагмент финальной загадки'
        },
        2: {
            'text': '''Загадка #2\nОтветы принимаются до 03.02 08:00\n
            В далеком прошлом, в веках минувших, 
            Секреты мои в тени скрыты, 
            Кто я, скажи, если в III веке, 
            Мудрец меня описал, не в шутке. 
            Ложка моя, из магнита сделана, 
            С узкой ручкой, форма — как шар, 
            С помощью меня, дороги открыты, 
            Что за изобретение, скажи, не зная преград?.''',
            'correct_answer': 'компас',
            'hint': 'В конструкции использовался магнитный минерал, который позволяет ему указывать на сторону света',
            'hint_delay': 7200,  # 2 минуты в секундах
            'image_correct': 'question2_fragment.png',
            'wrong_answer_text': 'Ой-ой-ой! Это не то, что мы загадали. Но не переживайте, вы еще можете победить.',
            'correct_answer_text': 'Поздравляем, вы правильно ответили на вопрос, держите фрагмент финальной загадки'
        },
        3: {
            'text': '''Загадка #3\nОтветы принимаются до 05.02 08:00\n
            Китай — страна с одной из самых высоких степеней индустриализации и урбанизации в мире регулярно сталкивается с серьезными экологическими вызовами. Однако, в последние годы, благодаря государственной поддержке и частным инвестициям, Китай становится лидером в области экологических технологий. Взгляните на картинки и напишите название провинции, в которой в 2018 году был реализован революционный проект, который тут зашифрован.''',
            'correct_answer': 'сычуань',
            'question_image': 'question3.jpg',
            'image_correct': 'question3_fragment.png',
            'wrong_answer_text': 'Ой-ой-ой! Это не то, что мы загадали. Но не переживайте, вы еще можете победить.',
            'correct_answer_text': 'Поздравляем, вы правильно ответили на вопрос, держите фрагмент финальной загадки'
        },
        4: {
            'text': '''Загадка #4\nОтветы принимаются до 07.02 08:00\n
        Вы удивитесь, но в Китае очень любят русские песни. Напишите название песни, которая звучит.''',
            'correct_answer': 'группа крови',
            'image_correct': 'question4_fragment.png',
            'video_path': 'videoquestion.mp4',
            'wrong_answer_text': 'Ой-ой-ой! Это не то, что мы загадали. Но не переживайте, вы еще можете победить.',
            'correct_answer_text': 'Поздравляем, вы правильно ответили на вопрос, держите фрагмент финальной загадки'
        },
        5: {
            'text': '''Загадка #5\nОтветы принимаются до 10.02 08:00\n
            Одной из 30 вакансий, на которые откликнулся ЭТОТ ЧЕЛОВЕК после окончания колледжа, была позиция сотрудника ресторанов общественного питания KFC.
    Из 24 кандидатов KFC утвердила 23, и ОН был единственным претендентом, не получившим работу.

    Так же ОН утверждает, что мало что смыслит в информационных технологиях, хотя ОН владеет одной из самых успешных технологических компаний в мире.
    «Я совсем не разбираюсь в информационных технологиях. Единственное, что я могу, — использовать компьютер, чтобы загружать страницы в интернете, а также отправлять и получать электронные сообщения».

    О ком идет речь?''',
            'correct_answer': 'джек ма',
            'image_correct': 'question5_fragment.png',
            'wrong_answer_text': 'Ой-ой-ой! Это не то, что мы загадали. Но не переживайте, вы еще можете победить.',
            'correct_answer_text': 'Поздравляем, вы правильно ответили на вопрос, держите фрагмент финальной загадки'
        },
        6: {
            'text': '''Настало время собрать все фрагменты и написать что же за товар мы загадали?
Пишите свою версию, но хорошенько подумайте, у вас только одна попытка!\nОтветы принимаются до 12.02 10:59\nИтоги подведем 12 февраля.''',
            'question_image': 'question6.png',
            'collect_answers': True
        }
    }


def get_initial_info_posts():
    """Базовая структура информационных постов без времени"""
    return {
        1: {
            'text': '''Китайский Новый год!
В некоторых регионах Китая существует традиция "первого визита". В первый день Нового года люди стараются не посещать своих друзей и соседей, чтобы не принести им неудачу. Вместо этого они ждут, пока кто-то не посетит их первым.
''',
            'image_path': 'infopost1.jpg',
        },
        2: {
            'text': '''Правда или миф?\n Как вы думаете что из этого правда, а что миф? Баллы не дадим, но кругозор расширим.
        - У китайцев есть традиция есть пельмени на Новый год для привлечения удачи.
        - Все китайцы отмечают Новый год в один и тот же день, независимо от региона.
        - Великая китайская стена видна с Луны невооруженным глазом.
        - В Китае полагается, что густые бороды приносят удачу.
        - В Китае принято дарить часы на день рождения.
        - Существует традиция выбрасывать ненужные вещи в Новый год, чтобы освободить место для нового счастья.
        - В Китае люди употребляют чай на завтрак, обед и ужин.
        - Китайцы используют фейерверки исключительно для празднования китайского Нового года.
        - В Китае "число 8" считается неудачным.
        - Лунный календарь используется в Китае для определения всех важных праздников и мероприятий.''',
        },
        3: {
            'text': ''' 
            Сегодня мы предлагаем вам потренировать свою внимательность вместе со всем известной героиней китайской поэмы Khua Mulan (кит. 花木兰), которая пошла на войну вместо своего престарелого отца, несмотря на то, что в армию принимали только мужчин.

        Поэма «Песня о Мулан» была написана в VI веке, но, к сожалению, первоначальная версия не сохранилась. Позднейшая версия, собранная в XII веке Го Маоцзяном, стала основой для многих интерпретаций. Интересно, имела ли Mulan реальный прототип — это остается загадкой.

        Что нужно сделать?
        Найдите 11 отличий в кадре всемирно известного мультфильма о храброй Мулан!''',
            'image_path': 'infopost3.png'
        }
    }


def initialize_times():
    """Инициализация времен для вопросов и инфо-постов"""
    questions = get_initial_questions()
    info_posts = get_initial_info_posts()

    # Устанавливаем конкретные даты и времена для вопросов
    question_schedule = {
        1: {'start': '2025-01-29 09:00', 'end': '2025-01-30 08:00'},
        2: {'start': '2025-01-31 09:00', 'end': '2025-02-03 08:00'},
        3: {'start': '2025-02-03 09:00', 'end': '2025-02-05 08:00'},
        4: {'start': '2025-02-05 09:00', 'end': '2025-02-07 08:00'},
        5: {'start': '2025-02-07 09:00', 'end': '2025-02-10 08:00'},
        6: {'start': '2025-02-10 09:00', 'end': '2025-02-12 11:00'}
    }

    # Устанавливаем конкретные даты и времена для инфопостов
    info_post_schedule = {
        1: '2025-02-01 09:00',
        2: '2025-02-06 09:00',
        3: '2025-02-08 09:00'
    }

    # Применяем расписание к вопросам
    for q_id, times in question_schedule.items():
        questions[q_id]['start_time'] = moscow_tz.localize(datetime.strptime(times['start'], '%Y-%m-%d %H:%M'))
        questions[q_id]['end_time'] = moscow_tz.localize(datetime.strptime(times['end'], '%Y-%m-%d %H:%M'))
        questions[q_id]['notified'] = False

    # Применяем расписание к инфопостам
    for post_id, time_str in info_post_schedule.items():
        info_posts[post_id]['publish_time'] = moscow_tz.localize(datetime.strptime(time_str, '%Y-%m-%d %H:%M'))
        info_posts[post_id]['notified'] = False

    return questions, info_posts


# Инициализируем глобальные переменные
QUESTIONS, INFO_POSTS = initialize_times()


def reset_times():
    """Функция для сброса времен (используется при перезапуске)"""
    global QUESTIONS, INFO_POSTS
    QUESTIONS, INFO_POSTS = initialize_times()